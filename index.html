<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Task Queue is implemented in R for asynchronous tasks based on 
             PostgreSQL &lt;https://www.postgresql.org/&gt; database to deal with 
             uneven load balance among workers and utilise new available workers. 
             This package is only suitable for parallel computing without 
             any communication among parallel tasks and to distribute asynchronous tasks
             to multiple workers. ">
<title>Task Queue in R Based On PostgreSQL  • taskqueue</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Task Queue in R Based On PostgreSQL ">
<meta property="og:description" content="Task Queue is implemented in R for asynchronous tasks based on 
             PostgreSQL &lt;https://www.postgresql.org/&gt; database to deal with 
             uneven load balance among workers and utilise new available workers. 
             This package is only suitable for parallel computing without 
             any communication among parallel tasks and to distribute asynchronous tasks
             to multiple workers. ">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-4HPNYGL5FT"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4HPNYGL5FT');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">taskqueue</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/byzheng/taskqueue/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="taskqueue">taskqueue<a class="anchor" aria-label="anchor" href="#taskqueue"></a>
</h1></div>
<p><a href="https://cran.r-project.org/package=taskqueue" class="external-link"><img src="https://www.r-pkg.org/badges/version/taskqueue?color=green"></a> <img src="https://github.com/byzheng/taskqueue/workflows/R-CMD-check/badge.svg" alt="R-CMD-check"></p>
<p><a href="https://cran.r-project.org/package=taskqueue" class="external-link"><img src="http://cranlogs.r-pkg.org/badges/grand-total/taskqueue?color=green"></a> <a href="https://cran.r-project.org/package=taskqueue" class="external-link"><img src="http://cranlogs.r-pkg.org/badges/last-month/taskqueue?color=green"></a> <a href="https://cran.r-project.org/package=taskqueue" class="external-link"><img src="http://cranlogs.r-pkg.org/badges/last-week/taskqueue?color=green"></a></p>
<p>Task Queue is implemented in R for asynchronous tasks based on <a href="https://www.postgresql.org/" class="external-link">PostgreSQL</a> database. This package is only suitable for parallel computing without any communication among parallel tasks (i.e. <a href="https://en.wikipedia.org/wiki/Embarrassingly_parallel" class="external-link">Embarrassingly parallel</a>).</p>
<div class="section level2">
<h2 id="challenge-of-parallel-computing-in-r">Challenge of parallel computing in R<a class="anchor" aria-label="anchor" href="#challenge-of-parallel-computing-in-r"></a>
</h2>
<p>Several R packages have been using for parallel computing (e.g. <a href="https://cran.r-project.org/web/views/HighPerformanceComputing.html" class="external-link">High-Performance and Parallel Computing with R</a> which are not suitable for asynchronous tasks.</p>
<ul>
<li>Uneven load among cores/workers. Some workers run faster than others and then wait for others to stop.</li>
<li>Cannot utilise the new available workers after a parallel task is started.</li>
</ul>
<p><code>taskqueue</code> is designed to utilise all available computing resources until all tasks are finished through dynamic allocating tasks to workers.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>Install the developing version from <a href="https://github.com/byzheng/taskqueue" class="external-link">Github</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">'byzheng/taskqueue'</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="postgresql-installation-and-configuration">PostgreSQL installation and configuration<a class="anchor" aria-label="anchor" href="#postgresql-installation-and-configuration"></a>
</h2>
<p>As large amount of concurrent requests might simultaneously reach the database, a specific server is preferred to install PostgreSQL database and can be connected by all workers. Following the <a href="https://www.postgresql.org/download/" class="external-link">PostgreSQL website</a> to install and configure PostgreSQL. A database should be created for each user.</p>
<p>In all workers, five environmental variables should be added to <code>.Renviron</code> file to connect database, i.e.</p>
<pre><code>PGHOST=
PGPORT=
PGUSER=
PGPASSWORD=
PGDATABASE=</code></pre>
</div>
<div class="section level2">
<h2 id="resource">Resource<a class="anchor" aria-label="anchor" href="#resource"></a>
</h2>
<p>A computing resource is defined as a facility/computer which can run multiple jobs/workers.</p>
<p>A new resource can be added by <code>resource_add</code> with configurations.</p>
<ul>
<li>
<code>name</code> as resource name</li>
<li>
<code>type</code> resource type. Only support <code>slurm</code> at this stage</li>
<li>
<code>host</code> network name to access resource</li>
<li>
<code>nodename</code> obtain by <code><a href="https://rdrr.io/r/base/Sys.info.html" class="external-link">Sys.info()</a></code> in the resource</li>
<li>
<code>workers</code> maximum number of available cores in resource</li>
<li>
<code>log_folder</code> folder to store log files in the resource</li>
</ul>
<p>Currently only <code>slurm</code> is supported although I plan to implement other types of resource.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/resource_add.html">resource_add</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"hpc"</span>, </span>
<span>            type <span class="op">=</span> <span class="st">"slurm"</span>, </span>
<span>            host <span class="op">=</span> <span class="st">"hpc.example.com"</span>, </span>
<span>            nodename <span class="op">=</span> <span class="st">"hpc"</span>,</span>
<span>            workers <span class="op">=</span> <span class="fl">500</span>,</span>
<span>            log_folder <span class="op">=</span> <span class="st">"/home/user/log_folder/"</span><span class="op">)</span></span></code></pre></div>
<p><code>log_folder</code> is important for troubleshooting and split by <code>project</code>. It wouble be better to store in the high speed hard drive as the frequent I/O process to write log files.</p>
</div>
<div class="section level2">
<h2 id="project">Project<a class="anchor" aria-label="anchor" href="#project"></a>
</h2>
<p><code>taskqueue</code> manages tasks by project which has its own resources, working directory, runtime requirements and other configurations.</p>
<p>A project with unique name can be created by <code>project_add</code> function and assign common requirements (e.g. memory).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/project_add.html">project_add</a></span><span class="op">(</span><span class="st">"test_project"</span>, memory <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<p>Assign a <code>resource</code> to <code>project</code> which can be used to schedule workers with configurations (e.g. working directory, total runtimes, project specified workers).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/project_resource_add.html">project_resource_add</a></span><span class="op">(</span>project <span class="op">=</span> <span class="st">"test_project"</span>, </span>
<span>                     resource <span class="op">=</span> <span class="st">"hpc"</span><span class="op">)</span></span></code></pre></div>
<p>Now tasks can be added into database through function <code>task_add</code>, e.g. </p>
<pre><code><span><span class="fu"><a href="reference/task_add.html">task_add</a></span><span class="op">(</span><span class="va">project</span>, num <span class="op">=</span> <span class="fl">100</span>, clean <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
<p>Now we can develop a function to actually perform data processing, which</p>
<ul>
<li>takes task <code>id</code> as the first argument,</li>
<li>expect no return values,</li>
<li>save final output into file system and check whether this task is finished.</li>
</ul>
<p>Finally, call <code>worker</code> to run wrapper function with project name.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://taskqueue.bangyou.me/">taskqueue</a></span><span class="op">)</span></span>
<span><span class="va">fun_test</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Check output file</span></span>
<span>    <span class="va">out_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s.Rds"</span>, <span class="va">i</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">out_file</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="co"># Perform the actual computing</span></span>
<span>    <span class="co"># ....</span></span>
<span>    </span>
<span>    <span class="co"># Save final output</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">out_file</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="reference/worker.html">worker</a></span><span class="op">(</span><span class="st">"test1"</span>, <span class="va">fun_test</span><span class="op">)</span></span></code></pre></div>
<p>After developing and testing the wrapper function, we can save it into a file (e.g. <code>rcode.R</code>) and then schedule to run it with following functions.</p>
<ul>
<li>Reset all or <code>failed</code>/<code>working</code> tasks to <code>idle</code> status with <code>project_reset</code>
</li>
<li>Start the project to allow workers consuming tasks with <code>project_start</code>
</li>
<li>Schedule tasks into resources (e.g. <code>worker_slurm</code> for slurm cluster)</li>
<li>Check task status with <code>task_status</code>
</li>
<li>Stop project with <code>project_stop</code>
</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Reset status for all tasks in a project </span></span>
<span><span class="fu"><a href="reference/project_reset.html">project_reset</a></span><span class="op">(</span><span class="st">"test1"</span><span class="op">)</span></span>
<span><span class="co"># Start project</span></span>
<span><span class="fu"><a href="reference/project_start.html">project_start</a></span><span class="op">(</span><span class="st">"test1"</span><span class="op">)</span></span>
<span><span class="co"># Schedule task on slurm resource `hpc`</span></span>
<span><span class="fu"><a href="reference/worker_slurm.html">worker_slurm</a></span><span class="op">(</span><span class="st">"test1"</span>, <span class="st">"hpc"</span>, <span class="st">"rcode.R"</span>, modules <span class="op">=</span> <span class="st">"sqlite/3.43.1"</span><span class="op">)</span></span>
<span><span class="co"># Check status of all tasks</span></span>
<span><span class="fu"><a href="reference/task_status.html">task_status</a></span><span class="op">(</span><span class="st">"test1"</span><span class="op">)</span></span>
<span><span class="co"># Stop the project</span></span>
<span><span class="fu"><a href="reference/project_stop.html">project_stop</a></span><span class="op">(</span><span class="st">"test1"</span><span class="op">)</span></span></code></pre></div>
<p>A task has four status</p>
<ul>
<li>
<code>idle</code>: task is not running.</li>
<li>
<code>working</code>: task is still running on one of worker.</li>
<li>
<code>failed</code>: task is failed with some reason. Check the log folder for trouble shooting.</li>
<li>
<code>finished</code>: task is finished without errors.</li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/byzheng/taskqueue/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/byzheng/taskqueue/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li>
<a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a>
</li>
</ul>
</div>

<div class="community">
<h2 data-toc-skip>Community</h2>
<ul class="list-unstyled">
<li><a href="CODE_OF_CONDUCT.html">Code of conduct</a></li>
</ul>
</div>

<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing taskqueue</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Bangyou Zheng <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Bangyou Zheng.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
